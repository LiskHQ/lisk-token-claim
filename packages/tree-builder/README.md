# Tree Builder
This library builds Merkle Tree from a snapshot and computes Merkle Root.

## Run

```
$ cd packages/tree-builder
$ ./bin/
```

## Files

| Name                                               | Description                                                                                                                                                                           | Generated By                            |
|----------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------| --------------------------------------- |
| `/data/<network>/accounts.json`                    | Stores addresses, balances, and multisig details(If any) per account after a snapshot is taken, addresses must be sorted in ascending order. Will be used for MerkleTree computation. | Snapshot                                |
| `/data/<network>/merkle-tree-result-detailed.json` | Stores MerkleRoot, and leaves for each account. Will be used for examination by 3rd Party or public, also used by Claim Backend API.                                                  | `$ yarn generate-merkle-tree:<network>` |
| `/data/<network>/merkle-tree-result.json`          | Stores MerkleRoot, and leaves for each account. Will be used for testing for Claim Contract.                                                                           | `$ yarn generate-merkle-tree:<network>` |
| `/data/<network>/merkle-root.json`                 | Stores MerkleRoot only. Will be used for deployment of Claim Contract.                                                                                                                | `$ yarn generate-merkle-tree:<network>` |

## Merkle Leaf

Each leaf will be encoded as ABI-format, in the following order:

```
LSK_ADDRESS_IN_HEX: bytes20
BALANCE_IN_BEDDOWS: uint64
NUMBER_OF_SIGNATURES: uint32
MANDATORY_KEYS: bytes32[]
OPTIONAL_KEYS: bytes32[]

P.S. If the address is not a multisig address, NUMBER_OF_SIGNATURES would be 0, MANDATORY_KEYS and OPTIONAL_KEYS be []
```

## Params

```
accounts.json:
{
    lskAddress: string;
    balance: number;
    balanceBeddows: number;
    numberOfSignatures?: number;
    mandatoryKeys?: string[];
    optionalKeys?: string[];
}

merkle-tree-result-detailed.json:
{
    merkleRoot: string;
    leaves: {
        lskAddress: string;
        address: string;
        balance: number;
        balanceBeddows: number;
        numberOfSignatures: number;
        mandatoryKeys: string[];
        optionalKeys: string[];
        hash: string;
        proof: string[];
    }[];
}

merkle-tree-result.json:
{
  merkleRoot: string;
  leaves: {
    b32Address: string;
    balanceBeddows: number;
    mandatoryKeys: string[];
    numberOfSignatures: number;
    optionalKeys: string[];
    proof: string[];
  }[];
}
# `address` is a reserved in solidity, hence `b32Address` here
```

### `merkle-tree-simple`

Due to the constraint of vm.parseJson in Foundry, fields in `merkle-tree-result` such as decimal field will trigger error.

`merkle-tree-simple.json` is a lightweight version of `merkle-tree-result-detailed.json`, which also has sufficient params for claiming.

## _Testing Only_

### Generate accounts.json from `dev-validators.json`

```
$ yarn create-accounts:example
```

### (After running `generate-merkle-tree:example`) Sign all accounts and generates `signatures.json`

```
$ yarn sign:example
```

### Params (For testing purposes only)

```
signatures.json:
{
  message: string;
  sigs: {
    pubKey: string
    r: string
    s: string
  }[];
}[];
```
